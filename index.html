<!DOCTYPE html>
<html>

<head>
<meta charset='utf-8'>
<style>
	#container{
		margin: 10px auto 10px auto;
	}
		
	.casa {
		display: flex;
		justify-content: center; /* align horizontal */
		align-items: center;
		transition: background-color 610ms;
		float:left;
		border: #BBB solid 1px;
	}
	
	.casa0 { background-color: #CCC }
	.casa1 { background-color: #3695D6 } 
	.casa2 { background-color: #DC7538 }
	
	.jogador1 { color: #3695D6 } 
	.jogador2 { color: #DC7538 }
	
	.possivel {
		background-color: #CDC;
		display: flex;
		justify-content: center; /* align horizontal */
		align-items: center;
		transition: background-color 610ms;
		float:left;
		border: #BBB solid 1px;
	}
	
	.casa:hover {
		background-color: #E03535;
	}
	
	.possivel:hover {	
		background-color: #34A55E;
	}
	
	/*.casa-top-left { border-top-left-radius: 25px }
	.casa-top-right { border-top-right-radius: 25px }
	.casa-bottom-left { border-bottom-left-radius: 25px; }
	.casa-bottom-right { border-bottom-right-radius: 25px; }*/
	
</style>

<script src="jquery-2.1.4.js"></script>
<script src="hashtable.js"></script>
<script src="hashset.js"></script>
<script src="Casa.js"></script>
<script src="Tabuleiro.js"></script>
<script src="Jogador.js"></script>
<script src="Jogada.js"></script>
<script>
	window.onload = function(){
		var timer;
		
		var jogadores = [new Jogador(), new Jogador()];
		jogadores[0].oponente = jogadores[1];
		jogadores[1].oponente = jogadores[0];
		//console.log(jogadores);
	
		var jogadorDaVez = jogadores[1].passarVez();
		
		comecarTimer();
		
		var jogadas = new Array();
		
		// ---------------------------------------------------
		/*var  v = ["", ".", "..", "..."];
		var i = 0;
		setInterval(function () {
			i %= 4;
			document.getElementById("loading").innerHTML = v[i];
			i++ ;
		}, 500);*/
		// ---------------------------------------------------

		var t = new Tabuleiro("container", 455, 8);
		t.casas[3][3].tipo = Tipo.JOGADOR2;
		t.casas[4][4].tipo = Tipo.JOGADOR2;
		t.casas[3][4].tipo = Tipo.JOGADOR1;
		t.casas[4][3].tipo = Tipo.JOGADOR1;

		/*t.casas[4][3].tipo = Tipo.JOGADOR1;
		t.casas[4][4].tipo = Tipo.JOGADOR1;
		t.casas[4][5].tipo = Tipo.JOGADOR1;
		
		t.casas[3][3].tipo = Tipo.JOGADOR2;
		t.casas[3][4].tipo = Tipo.JOGADOR2;
		t.casas[3][5].tipo = Tipo.JOGADOR2;	*/

		t.mostrarPossiveis(jogadorDaVez.id);
		t.refresh();
		
		for (var i = 0; i < t.casas.length; i++)	
			for (var j = 0; j < t.casas[i].length; j++){
				t.casas[i][j].div.addEventListener("click", function(event){
					selecionarDiv(event.target);
				});	
			}
			
		document.forms[0].desfazer.addEventListener("click", function(){
			desfazerJogada(t);
		});

		$("#container").bind('mousewheel', function(event) {
			if (event.originalEvent.wheelDelta >= 0) {
				t.dimensao += 5;
			}
			else {
				t.dimensao -= 5;
			}
			t.refresh();
		});
		
		function selecionarDiv(div){
			//console.log(div);
			var x, y;
			var num = div.id.substring(div.id.length - 2, div.id.length);
			x = parseInt(num.charAt(0));
			y = parseInt(num.charAt(1));
			
			var casa = t.casas[x][y];
			if (t.jogadaValida(casa))
				selecionarCasa(casa);
		}
		
		function selecionarCasa(casa){
			//TODO deve ser feita uma cópia de jogadorDaVez em vez de passar o objeto inteiro
			// por enquanto funcionará, mas quando for necessário restaurar a quantidade de jogadas e pontos
			// será necessária a cópia
			jogadas.push(new Jogada(casa, t.obterTriplas(), jogadorDaVez));
			jogadorDaVez = t.jogar(casa, jogadorDaVez);
			
			//IA nivel 1
			/*iaJogando = 1;

			for(var w = 0; w < iaJogando; w++){
				if(jogadorDaVez.id == 2){
					var casasPossiveisJ2 = t.jogadasPossiveis(Tipo.JOGADOR2);
					var melhorCasaId = 0;
					var melhorCasaQtdJogadas = 100;

					if(casasPossiveisJ2.length > 0){
						for (var i = 0; i < casasPossiveisJ2.length; i++) {
				        	if(casasPossiveisJ2.length == 1){
				        		melhorCasaId = i;
				        		console.log("Ha apenas a casa possivel " + i + " pra ser jogada");
				        	}
				        	else{
								jogadas.push(new Jogada(casasPossiveisJ2[i], t.obterTriplas(), jogadorDaVez));
								casasPossiveisJ2[i].tipo = Tipo.JOGADOR2;

								var caminhos = t.todosCaminhos(casasPossiveisJ2[i], jogadorDaVez.id);
						
								for (var j = 0; j < caminhos.length; j++)
									for (var k = 0; k < caminhos[j].length; k++){
										x = caminhos[j][k].x;
										y = caminhos[j][k].y;
										t.casas[x][y].tipo = jogadorDaVez.id;
									}

								jogadorDaVez = jogadorDaVez.passarVez();
								casasPossiveisJ1 = t.jogadasPossiveis(Tipo.JOGADOR1);
								desfazerJogada(t);

								if(casasPossiveisJ1.length < melhorCasaQtdJogadas){
									melhorCasaId = i;
									melhorCasaQtdJogadas = casasPossiveisJ1.length;
								}

								console.log("Casa possivel " + i + ": " + casasPossiveisJ2[i].y + " " + casasPossiveisJ2[i].x + ", que gera " + casasPossiveisJ1.length + " jogadas ao adversario");
					        }
						}

						console.log("A casa possivel " + melhorCasaId + " deve ser jogada");

						jogadas.push(new Jogada(casasPossiveisJ2[melhorCasaId], t.obterTriplas(), jogadorDaVez)); 
						casasPossiveisJ2[melhorCasaId].tipo = Tipo.JOGADOR2;
						var caminhos = t.todosCaminhos(casasPossiveisJ2[melhorCasaId], jogadorDaVez.id);
					
						for (var i = 0; i < caminhos.length; i++)
							for (var j = 0; j < caminhos[i].length; j++){
								x = caminhos[i][j].x;
								y = caminhos[i][j].y;
								t.casas[x][y].tipo = jogadorDaVez.id;
							}
							
						t.refresh();

						if(melhorCasaQtdJogadas > 0){
							jogadorDaVez = jogadorDaVez.passarVez();
							t.mostrarPossiveis(jogadorDaVez.id);
						}
						else if(melhorCasaQtdJogadas == 0 && !t.fimDoJogo()){
							iaJogando++;
							console.log("O jogador passou a vez, pois nao havia mais jogadas");
						}
					}				
				}
			}*/

			//IA nivel 2
			var iaJogando = true;

			while (iaJogando){
				if(jogadorDaVez.id == 2){
					var casasPossiveisJ2 = t.jogadasPossiveis(Tipo.JOGADOR2);
					var melhorCasaId = 0;
					var melhorCasaQtdJogadas = 100;
					var quina = false;

					if(casasPossiveisJ2.length > 0){
						var triplasAntigas = t.obterTriplas();
						for (var i = 0; i < casasPossiveisJ2.length; i++) {
				        	if(casasPossiveisJ2.length == 1){
				        		melhorCasaId = i;
				        		console.log("Ha apenas a casa possivel " + i + " pra ser jogada");
				        	}
				        	else if(casasPossiveisJ2[i].y == 0 && casasPossiveisJ2[i].x == 0 ||
			        	   			casasPossiveisJ2[i].y == 0 && casasPossiveisJ2[i].x == 7 ||
			        	   			casasPossiveisJ2[i].y == 7 && casasPossiveisJ2[i].x == 0 ||
			        	   			casasPossiveisJ2[i].y == 7 && casasPossiveisJ2[i].x == 7){
			        					melhorCasaId = i;
			        					console.log("Casa possivel " + i + ": " + casasPossiveisJ2[i].y + " " + casasPossiveisJ2[i].x + ", eh uma quina");
			        					break;
				        	}
				        	else{
				        		//jogadas.push(new Jogada(casasPossiveisJ2[i], t.obterTriplas(), jogadorDaVez));
								//casasPossiveisJ2[i].tipo = Tipo.JOGADOR2;
								t.simularJogada(casasPossiveisJ2[i], jogadorDaVez);
								/*casasPossiveisJ2[i].tipo = jogadorDaVez.id;

								var caminhos = t.todosCaminhos(casasPossiveisJ2[i], jogadorDaVez.id);
						
								for (var j = 0; j < caminhos.length; j++)
									for (var k = 0; k < caminhos[j].length; k++){
										x = caminhos[j][k].x;
										y = caminhos[j][k].y;
										t.casas[x][y].tipo = jogadorDaVez.id;
									}*/

								//jogadorDaVez = jogadorDaVez.passarVez();
								//casasPossiveisJ1 = t.jogadasPossiveis(Tipo.JOGADOR1);
								casasPossiveisJ1 = t.jogadasPossiveis(jogadorDaVez.oponente.id);
								
								for (var j = 0; j < casasPossiveisJ1.length; j++){
									if(casasPossiveisJ1[j].y == 0 && casasPossiveisJ1[j].x == 0 ||
				        	   		   casasPossiveisJ1[j].y == 0 && casasPossiveisJ1[j].x == 7 ||
				        	   		   casasPossiveisJ1[j].y == 7 && casasPossiveisJ1[j].x == 0 ||
				        	   		   casasPossiveisJ1[j].y == 7 && casasPossiveisJ1[j].x == 7){
				        				quina = true;
				        				console.log("Casa possivel " + i + ": " + casasPossiveisJ2[i].y + " " + casasPossiveisJ2[i].x + ", foi ignorada, pois permitiria que o adversario jogasse numa quina");
				        				break;
				        			}
								}

								console.log("Casa possivel " + i + ": " + casasPossiveisJ2[i].y + " " + casasPossiveisJ2[i].x + ", que gera " + casasPossiveisJ1.length + " jogadas ao adversario");

								t.restaurarTriplas(triplasAntigas, jogadorDaVez);

								if(casasPossiveisJ1.length < melhorCasaQtdJogadas && quina == false){
									melhorCasaId = i;
									melhorCasaQtdJogadas = casasPossiveisJ1.length;
								}

								quina = false;
				        	}
						}

						console.log("A casa possivel " + melhorCasaId + " deve ser jogada");

						jogadas.push(new Jogada(casasPossiveisJ2[melhorCasaId], t.obterTriplas(), jogadorDaVez)); 
						
						jogadorDaVez = t.jogar(casasPossiveisJ2[melhorCasaId], jogadorDaVez);
						
						iaJogando = false;
						
						if(melhorCasaQtdJogadas == 0 && !t.fimDoJogo()){
							iaJogando = true;
							console.log("O jogador passou a vez, pois nao havia mais jogadas");
						}
					}				
				}
			}

			while (t.possiveisUltimaJogada.length == 0){
				if (t.fimDoJogo()) {
					/*var azul = 0;
					var vermelho = 0;

					for (var i = 0; i < t.casas.length; i++) {
						for (var j = 0; j < t.casas[i].length; j++) {
							if(t.casas[i][j].tipo == Tipo.JOGADOR2){
								vermelho++;
							}
							else if(t.casas[i][j].tipo == Tipo.JOGADOR1){
								azul++;
							}
						}
					}*/
					terminarTimer();
					
					//window.alert("Fim do Jogo - Azul: " + azul + " " + ", Vermelho: " + vermelho);	
					break;
				}
				jogadorDaVez = jogadorDaVez.passarVez();
				t.mostrarPossiveis(jogadorDaVez.id);
			}
		}
		
		function desfazerJogada(tabuleiro){
			if (jogadas.length == 0){
				window.alert("Não há mais jogadas a serem desfeitas");
			}
			else{
				var ultimaJogada = jogadas.pop();
				tabuleiro.restaurarTriplas(ultimaJogada.triplas, ultimaJogada.jogador);
				jogadorDaVez = ultimaJogada.jogador.oponente.passarVez();
			}
			//console.log(tabuleiro);
			//console.log(jogador);
		}
		
		function comecarTimer(){
			timer = setInterval(function(){
				jogadorDaVez.tempo++;
			}, 1000);
		}
		
		function terminarTimer(){
			console.log("tempo jogador vez " + jogadorDaVez.tempo + 
			", oponente " + jogadorDaVez.oponente.tempo);
			clearInterval(timer);
		}		
		/*
		function trocarjogadorDaVez(){
			if (jogadorDaVez == Tipo.JOGADOR1)
				jogadorDaVez = Tipo.JOGADOR2;
			else
				jogadorDaVez = Tipo.JOGADOR1;
			$("#jogadorDaVez").text("Jogador " + jogadorDaVez);
		}*/
		
		//console.log(t.vizinhosVazios(1));
		
		/*
		console.log(t.existeCaminho(t.casas[4][3],t.casas[2][2]));
		console.log(t.existeCaminho(t.casas[2][2],t.casas[4][3]));
		console.log(t.existeCaminho(t.casas[2][2],t.casas[2][2]));
		
		console.log(t.existeCaminho(t.casas[3][4],t.casas[6][4]));
		
		console.log(t.existeCaminho(t.casas[3][7],t.casas[3][1]));
		
		console.log(t.existeCaminho(t.casas[7][7],t.casas[1][1]));
		
		console.log(t.existeCaminho(t.casas[5][3],t.casas[2][6]));
		*/
		
		/*
		console.log(t.caminho(t.casas[0][0], t.casas[7][7]));
		console.log(t.caminho(t.casas[7][7], t.casas[0][0]));
		console.log(t.caminho(t.casas[0][7], t.casas[1][6]));
		console.log(t.caminho(t.casas[0][7], t.casas[0][7]));
		*/
		
		//console.log(t.jogadasPossiveis(jogadorDaVez));
		//console.log(t.toString());
	};
	
	

</script>
</head>

<body>
	<p id="vez"></p>
	
	<div id="container">
	</div>
			
	<form>
		<input type="button" name="desfazer" value="Desfazer jogada" />
	</form>
			
	<pre id="loading">
	</pre>
	
</body>
</html>
